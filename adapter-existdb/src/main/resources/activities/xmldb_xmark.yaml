description: |
  This workload fills an xmldb: database with a file generated by xmlgen or xmlgen2
  We need to have a running xmldb, such as exist
  # Debug exist-db/startup.sh by adding this to java invocation:
  #     -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=127.0.01:4005
  # Run using this command:
  # java -jar <<jarfile>> <<this-file>> <<scenario>> [<<scenario>>*] <<paramname>>=<<paramvalue>>*
  # for example
  # java -jar ./nb5/target/nb5.jar ./adapter-existdb/target/classes/activities/xmldb_xmark.yaml xmark001 personcount=25000 auctionfile="auction-xmlgen2-f1.xml"

scenarios:
  clean:
    # existdb driver is effectively a generic xmldb driver
    schema:   run driver=existdb tags==block:"schema.*" threads==1 cycles==UNDEF endpoint=xmldb:exist://localhost:8080/exist/xmlrpc

  reset:
    # existdb driver is effectively a generic xmldb driver
    schema:   run driver=existdb tags==block:"schema.*" threads==1 cycles==UNDEF endpoint=xmldb:exist://localhost:8080/exist/xmlrpc
    install:   run driver=existdb tags==block:"install.*" threads==1 cycles==UNDEF endpoint=xmldb:exist://localhost:8080/exist/xmlrpc

  xmark001:
    # Repeat the read n times (total), with m concurrent threads
    warmup:     run driver=existdb tags==block:"xmark001.*",  cycles===TEMPLATE(warmup-cycles,5000) threads=auto errors=timer,warn endpoint=xmldb:exist://localhost:8080/exist/xmlrpc
    read:     run driver=existdb tags==block:"xmark001.*",  cycles===TEMPLATE(read-cycles,10000) threads=auto errors=timer,warn endpoint=xmldb:exist://localhost:8080/exist/xmlrpc

  xmark002:
    # Single threaded
    warmup:     run driver=existdb tags==block:"xmark002.*",  cycles===TEMPLATE(warmup-cycles,5) threads=1 errors=timer,warn endpoint=xmldb:exist://localhost:8080/exist/xmlrpc
    read:     run driver=existdb tags==block:"xmark002.*",  cycles===TEMPLATE(read-cycles,10) threads=1 errors=timer,warn endpoint=xmldb:exist://localhost:8080/exist/xmlrpc

  xmark003:
    # Single threaded
    warmup:     run driver=existdb tags==block:"xmark003.*",  cycles===TEMPLATE(warmup-cycles,5) threads=1 errors=timer,warn endpoint=xmldb:exist://localhost:8080/exist/xmlrpc
    read:     run driver=existdb tags==block:"xmark003.*",  cycles===TEMPLATE(read-cycles,10) threads=1 errors=timer,warn endpoint=xmldb:exist://localhost:8080/exist/xmlrpc

bindings:

  collection: FixedValue(<<collection:"db">>) -> String
  user: FixedValue(TEMPLATE(user,"admin")) -> String
  pass: FixedValue(TEMPLATE(pass,"")) -> String
  path: FixedValue(TEMPLATE(path,"/Users/alan/swProjects/evolvedBinary/nosqlbench")) -> String
  activities: FixedValue(TEMPLATE(activities,"adapter-existdb/target/classes/activities")) -> String

  cycleNum: Identity();
  personNum: Identity(); HashRange(0,TEMPLATE(personcount));

blocks:

  schema:
    ops:
      drop-collection:
        xquery version "3.1";

        import module namespace xmldb="http://exist-db.org/xquery/xmldb";

        let $mylogin := xmldb:login("/{collection}", "{user}", "{pass}")

        let $clean := if (fn:contains(xmldb:get-child-collections("/{collection}"), "auction"))
            then
                xmldb:remove("/db/auction")
            else
                ()
        return $clean

      create-collection:
        xquery version "3.1";

        import module namespace xmldb="http://exist-db.org/xquery/xmldb";

        let $mylogin := xmldb:login("/{collection}", "{user}", "{pass}")

        let $create-collection := xmldb:create-collection("/{collection}", "auction")
        let $create-collection-xmlgen := xmldb:create-collection("/{collection}/auction", "xmlgen")

        return
          $create-collection-xmlgen

  install:
    ops:
      install-auction:
        xquery version "3.1";

        import module namespace xmldb="http://exist-db.org/xquery/xmldb";

        let $mylogin := xmldb:login("/{collection}", "{user}", "{pass}")
        let $indexes := xmldb:store-files-from-pattern("/{collection}/system/config/{collection}", "{path}/{activities}", "collection.xconf")
        let $docs := xmldb:store-files-from-pattern("/{collection}/auction/xmlgen", "{path}/{activities}", "TEMPLATE(auctionfile)")
        return $docs

  xmark001:
    ops:
      # rename this op to read when you want to use it
      # nosqlbench doesn't let you called named scenarios in random files
      # otherwise we could put a scenario for every XMark query
      query:
        xquery version "3.1";

        for $b in /site/people/person[@id="person{personNum}"]
        return $b/name/text()

  xmark002:
    ops:
      query:
        xquery version "3.1";

        for $b in /site/open_auctions/open_auction
        return <increase>{$b/bidder[1]/increase/text()}</increase>

  xmark003:
    ops:
      query:
        xquery version "3.1";

        for $b in /site/open_auctions/open_auction
        where $b/bidder[1]/increase/text() * 2 <= $b/bidder[last()]/increase/text()
        return <increase first="{$b/bidder[1]/increase/text()}" last="{$b/bidder[last()]/increase/text()}" />


